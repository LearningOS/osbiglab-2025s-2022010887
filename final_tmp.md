# 大实验总结报告

黄雨婕 2022010887

## 一、总体架构设计

我们的OS主要基于 starry-next 和 arceos  实现，采用了模块化的内核设计，主要架构特点如下：

**内存管理（mm）：**

内存管理模块在该OS中主要负责用户态与内核态的地址空间隔离、内存分配、ELF文件加载、堆栈管理、信号trampoline映射等，强调安全隔离、灵活分配和多平台兼容，适合多进程多线程并发场景。

**进程与线程管理（process.rs）：用ProcessData和ThreadData分别管理进程和线程的生命周期、地址空间、信号、资源限制、futex、共享内存等。支持多线程、信号处理、资源隔离。**

进程与线程管理部分的结构大致如下：

- **进程（Process）** 位于 `process/src/process.rs`，每个进程有唯一的 pid，包含线程表、子进程表、父进程、进程组、会话等。进程可管理自己的线程、子进程、所属进程组和会话，支持 fork、exit、release 等操作。
- **线程（Thread）** 位于 `process/src/thread.rs`，每个线程有唯一的 tid，持有所属进程的弱引用。线程可判断自己是否为主线程，支持 exit 操作。
- **进程组（ProcessGroup）** 位于 `process/src/process_group.rs`，用于管理一组进程，支持添加/移除进程，属于某个会话。
- **会话（Session）** 位于 `process/src/session.rs`，用于管理一组进程组，支持添加/移除进程组。
- **线程/进程表** 通过BTreeMap(  `Mutex<BTreeMap<Pid, Arc<...>>>`  )管理所有进程和线程，支持高效查找和并发安全。

**信号机制：内核支持进程/线程级信号管理，信号trampoline机制用于用户态信号处理。**

本操作系统的信号机制实现了类 Unix 的进程/线程异步事件通知，主要特点如下：

1. **信号类型与分发**：支持多种信号（如 SIGKILL、SIGSTOP 等），信号可发送给线程、进程或进程组。信号通过 `send_signal_thread`、`send_signal_process`、`send_signal_process_group` 等函数分发。
2. **信号处理**：每个线程和进程维护自己的信号相关数据（如阻塞集、挂起集、处理动作等）。信号到达时，内核会在合适时机（如陷入内核后）检查并处理信号，通过 `check_signals` 触发对应的处理逻辑（终止、暂停、继续、用户自定义处理等）。
3. **信号阻塞与掩码**：支持通过 `sys_rt_sigprocmask` 等接口设置/查询信号阻塞集，实现信号的临时屏蔽。
4. **信号处理动作**：通过 `sys_rt_sigaction` 设置信号的处理方式（默认、忽略、自定义 handler）。
5. **信号等待与同步**：支持 `sys_rt_sigtimedwait`、`sys_rt_sigsuspend` 等接口，允许进程/线程同步等待特定信号。
6. **信号队列与实时信号**：部分接口（如 `sys_rt_sigqueueinfo`）支持带参数的信号队列，兼容实时信号机制。
7. **信号栈**：支持 `sys_sigaltstack` 设置备用信号栈，提升信号处理的健壮性。

整体设计兼容 Linux/POSIX 信号语义，便于用户态程序移植和多进程/多线程事件管理。

**文件系统（axfs）：提供文件读写、路径规范化等功能，支持用户程序加载和运行。**

我们的文件系统实现采用了分层设计，兼顾了 POSIX 兼容性和可扩展性，便于后续支持更多文件系统类型和高级特性。相关代码分布在 `api/src/imp/fs/` 目录下，包含如 `ctl.rs`（控制）、`fd_ops.rs`（文件描述符操作）、`io.rs`（读写）、`mount.rs`（挂载）、`path.rs`（路径处理）、`pipe.rs`（管道）、`poll.rs`（轮询）、`stat.rs`（状态）、`status.rs`（文件状态结构体）等模块。核心特点如下：

1. **POSIX 兼容层** 通过 `arceos_posix_api` 提供的接口，支持标准的文件操作（如 open、read、write、lseek、stat、poll、mount、umount 等），并实现了文件描述符表、目录和文件的抽象。
2. **路径与文件描述符管理** 支持：相对路径、绝对路径、基于 fd 的路径解析（如 openat、mkdirat、unlinkat 等），并有专门的路径解析工具函数。
3. **挂载机制** 支持：将设备（如镜像文件）挂载到指定目录，目前主要支持 vfat 文件系统类型。挂载点和设备通过 `MountedFs` 结构体管理，支持多挂载点。
4. **文件与目录抽象** 文件和目录都实现了 `FileLike` trait，支持统一的接口调用。目录遍历、文件类型识别、硬链接等功能也有实现。
5. **文件状态与属性** 支持标准的 stat、fstat、lstat、statx 等系统调用，返回兼容 Linux 的结构体，包含 inode、权限、时间戳等信息。
6. **管道与轮询** 实现了 pipe、poll、select 等机制，支持进程间通信和多路复用。

**同步与通信：支持futex、WaitQueue等同步原语，进程间可通过共享内存通信。**

同步与通信机制主要包括以下几个方面：

1. **Futex（Fast Userspace Mutex）机制**实现了类 Linux 的 futex 系统调用（如 `sys_futex`），支持 FUTEX\_WAIT、FUTEX\_WAKE、FUTEX\_REQUEUE 等操作。每个进程维护自己的 futex 表，底层通过 `WaitQueue` 实现线程阻塞与唤醒，支持带超时的等待。适用于高效的用户态锁实现和多线程同步。
2. **信号机制** 支持 POSIX 信号，包括进程/线程间异步事件通知。实现了 `sys_kill`、`sys_tkill`、`sys_tgkill`、`sys_rt_sigqueueinfo` 等系统调用，支持信号的发送、阻塞、处理、队列化和备用信号栈。信号可用于进程/线程间的异步通信和事件通知。
3. **管道与文件描述符** 文件系统层实现了管道（pipe），支持进程间的字节流通信。通过文件描述符进行读写，兼容 POSIX 标准接口。
4. **轮询与多路复用** 支持 `poll`、`select` 等系统调用，允许进程同时等待多个文件描述符的事件，便于实现高效的 I/O 多路复用。
5. **WaitQueue 等内核同步原语**
   内核内部广泛使用 `WaitQueue` 等同步原语，支持线程阻塞、唤醒、超时等待等，保证多线程/多进程环境下的资源安全访问。

整体设计兼容 Linux/POSIX 语义，既支持高效的用户态同步，也支持进程/线程间的多种通信方式，便于应用移植和系统扩展。

**// TODO**

资源限制与命名空间：实现了资源限制（如堆大小）和命名空间隔离，便于多进程环境下的安全与资源管理。
平台适配：通过axconfig::plat等配置项支持多平台（如RISC-V、LoongArch、AArch64等）移植。

## 二、你的OS的具体添加/扩展/创新设计实现

**// TODO:**

## 三、开发过程，描述碰到的问题和解决的过程，描述最终的实验结果

**// TODO:**

学习rust与熟悉starry框架

代码重构

合并别人的代码的困难

桩函数没设置警告导致的bug

内存泄漏

## 四、分析2024年OS比赛某一等奖作品并与自己写的OS的比较

npucore-impact 决赛一阶段文档

|          | undefined-os | npucore-impact |
| -------- | ------------ | -------------- |
| 平台支持 |              | 仅loongarch    |
| fork     |              | clone          |

| 文件系统 | undefined-os | npucore-impact |
| -------- | ------------ | -------------- |
| rwx权限  |              | 不检查         |
| procfs   |              | 无             |
| 挂载点   |              | 忽视           |
| 缓存     |              | 有简单实现     |

| task         | undefined-os | npucore-impact                           |
| ------------ | ------------ | ---------------------------------------- |
| session      |              | -                                        |
| processgroup |              | 设定了相关字段，但是没有实际实现相关内容 |
| thread       |              | ...                                      |

| 虚拟内存 | undefined-os | npucore-impact                                                  |
| -------- | ------------ | --------------------------------------------------------------- |
|          |              | 支持匿名映射、文件映射、懒分配（lazy alloc）、写时复制（CoW）。 |
| 页表     |              | 无多级页表，页表不回收？                                        |
| OOM 处理 |              | 尝试回收文件缓存、当前/所有进程内存                             |
